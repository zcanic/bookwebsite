<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AI Translation Reader</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- DOMPurify - XSS Protection -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
    <!-- Marked -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Noto+Sans+SC:wght@400;700&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">

    <style>
        /* --- 核心变量 --- */
        :root {
            --bg-color: #ffffff;
            --text-color: #1a1a1a;
            --dim-color: #6b7280;
            --accent-color: #2563eb;
            --meta-bg: #f3f4f6;
            --font-main: 'Noto Serif SC', serif;
            --line-height: 1.8;
        }

        /* --- 主题定义 --- */
        body.theme-sepia {
            --bg-color: #f8f4e9;
            --text-color: #433422;
            --dim-color: #8c7b67;
            --accent-color: #a67c52;
            --meta-bg: #ede6d6;
        }

        body.theme-dark {
            --bg-color: #18181b;
            --text-color: #e4e4e7;
            --dim-color: #a1a1aa;
            --accent-color: #60a5fa;
            --meta-bg: #27272a;
        }

        /* --- 字体定义 --- */
        body.font-serif { --font-main: 'Noto Serif SC', serif; }
        body.font-sans { --font-main: 'Noto Sans SC', sans-serif; }

        /* --- 基础样式 --- */
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            font-family: var(--font-main);
            -webkit-tap-highlight-color: transparent;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* --- Markdown 内容样式 --- */
        .markdown-body {
            font-family: var(--font-main);
            line-height: var(--line-height);
            font-size: 1.125rem;
        }

        .markdown-body h1 { font-size: 1.8em; font-weight: 700; margin-top: 1.2em; margin-bottom: 0.8em; line-height: 1.3; }
        .markdown-body h2 { font-size: 1.4em; font-weight: 700; margin-top: 1.5em; margin-bottom: 0.6em; border-bottom: none; }
        .markdown-body h3 { font-size: 1.2em; font-weight: 700; margin-top: 1.2em; margin-bottom: 0.5em; }

        .markdown-body p { margin-bottom: 1.2em; text-align: justify; }
        .markdown-body ul, .markdown-body ol { padding-left: 1.5em; margin-bottom: 1.2em; }
        .markdown-body li { margin-bottom: 0.4em; }

        .markdown-body blockquote {
            border-left: 4px solid var(--accent-color);
            padding-left: 1em;
            margin-left: 0;
            color: var(--dim-color);
            font-style: italic;
            background: linear-gradient(to right, var(--meta-bg), transparent);
            padding-top: 0.5em;
            padding-bottom: 0.5em;
            border-radius: 0 8px 8px 0;
        }

        .markdown-body code { background: var(--meta-bg); padding: 0.2em 0.4em; border-radius: 4px; font-size: 0.9em; font-family: monospace; }
        .markdown-body hr { border: 0; height: 1px; background: var(--dim-color); opacity: 0.2; margin: 2.5em 0; }

        /* 翻译强调色 */
        .markdown-body strong { font-weight: 700; color: var(--accent-color); }

        /* 元数据块样式 */
        .metadata-block {
            background-color: var(--meta-bg);
            border-radius: 12px;
            padding: 1.2rem;
            font-size: 0.95rem;
            margin-bottom: 2rem;
            font-family: 'Noto Sans SC', sans-serif;
            border: 1px solid rgba(0,0,0,0.05);
        }
        body.theme-dark .metadata-block { border: 1px solid rgba(255,255,255,0.1); }

        /* --- 纯净模式逻辑 (只看译文) --- */

        /* 默认双语模式 */
        body.mode-bilingual .is-original {
            color: var(--dim-color);
            font-size: 0.95em;
        }

        /* 纯净模式：隐藏原文、分隔符、元数据、大标题 */
        body.mode-pure .is-original,
        body.mode-pure hr,
        body.mode-pure .metadata-block,
        body.mode-pure .markdown-body h1 {
            display: none !important;
        }

        /* 纯净模式：隐藏【译文】前缀 */
        body.mode-pure .trans-prefix {
            display: none;
        }

        /* 纯净模式：调整译文样式使其像正文 */
        body.mode-pure .is-translation {
            color: var(--text-color);
            margin-top: 1.5em; /* 增加段间距，因为没有原文了 */
        }

        /* 加粗模式 */
        body.font-weight-bold .markdown-body {
            font-weight: 600; /* Semi-bold for better readability */
        }
        body.font-weight-bold .markdown-body p {
            font-weight: 500;
        }

        /* --- UI 细节 --- */
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }

        #settings-panel { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .active-option { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }
    </style>
</head>
<body class="theme-light font-serif mode-bilingual h-full flex flex-col">

    <!-- 顶部导航栏 -->
    <nav class="fixed top-0 left-0 right-0 z-50 bg-opacity-95 backdrop-blur-md border-b border-gray-200 dark:border-gray-800 transition-colors duration-300 safe-top" style="background-color: var(--bg-color);">
        <div class="flex items-center justify-between px-4 h-14">
            <button id="menu-btn" class="p-2 -ml-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition text-gray-600 dark:text-gray-300">
                <i class="ph ph-list text-2xl"></i>
            </button>

            <!-- 标题区域 -->
            <div class="flex flex-col items-center max-w-[60%]">
                <h1 id="header-title" class="text-sm font-bold truncate">加载中...</h1>
                <span id="page-indicator" class="text-[10px] opacity-60 font-mono">0%</span>
            </div>

            <button id="settings-btn" class="p-2 -mr-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition text-gray-600 dark:text-gray-300">
                <i class="ph ph-sliders-horizontal text-2xl"></i>
            </button>
        </div>
        <!-- 进度条 -->
        <div class="h-0.5 bg-gray-100 dark:bg-gray-800 w-full overflow-hidden">
            <div id="progress-bar" class="h-full bg-blue-600 transition-all duration-300" style="width: 0%"></div>
        </div>
    </nav>

    <!-- 主内容区 -->
    <main id="main-container" class="flex-1 w-full max-w-2xl mx-auto px-6 pt-24 pb-32 safe-bottom">
        <div id="content" class="markdown-body transition-opacity duration-300">
            <!-- Loading State -->
            <div class="flex flex-col items-center justify-center h-64 opacity-50 space-y-4">
                <i class="ph ph-spinner animate-spin text-3xl"></i>
                <p>正在渲染...</p>
            </div>
        </div>

        <!-- 翻页按钮 -->
        <div id="nav-buttons" class="mt-16 flex justify-between gap-4 hidden">
            <button id="prev-btn" class="flex-1 py-4 px-4 rounded-2xl bg-gray-100 dark:bg-zinc-800 font-medium hover:opacity-80 transition flex items-center justify-center gap-2 text-sm">
                <i class="ph ph-caret-left"></i> 上一章
            </button>
            <button id="next-btn" class="flex-1 py-4 px-4 rounded-2xl bg-blue-600 text-white font-bold shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition flex items-center justify-center gap-2 text-sm">
                下一章 <i class="ph ph-caret-right"></i>
            </button>
        </div>
    </main>

    <!-- 侧边目录 (Drawer) -->
    <div id="drawer-backdrop" class="fixed inset-0 bg-black/40 z-50 opacity-0 pointer-events-none transition-opacity duration-300" aria-hidden="true"></div>
    <div id="drawer" class="fixed inset-y-0 left-0 w-80 max-w-[85vw] bg-white dark:bg-zinc-900 z-50 transform -translate-x-full shadow-2xl flex flex-col transition-transform duration-300 safe-top safe-bottom">
        <div class="p-5 border-b border-gray-100 dark:border-zinc-800 flex justify-between items-center bg-gray-50 dark:bg-zinc-900/50">
            <h2 class="font-bold text-lg flex items-center gap-2">
                <i class="ph ph-books text-blue-600"></i> 目录
            </h2>
            <button id="close-drawer" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-zinc-800">
                <i class="ph ph-x text-lg"></i>
            </button>
        </div>
        <div id="chapter-list" class="flex-1 overflow-y-auto p-3 space-y-1">
            <!-- JS 生成目录 -->
        </div>
        <!-- 导出笔记按钮 -->
        <div class="p-4 border-t border-gray-100 dark:border-zinc-800">
            <button onclick="window.annotationManager.exportAnnotations()" class="w-full py-3 px-4 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2">
                <i class="ph ph-export text-xl"></i> 导出我的笔记
            </button>
        </div>
    </div>

    <!-- 设置面板 (Bottom Sheet) -->
    <div id="settings-panel" class="fixed bottom-0 left-0 right-0 bg-white dark:bg-zinc-900 z-50 transform translate-y-full rounded-t-3xl shadow-[0_-8px_30px_rgba(0,0,0,0.12)] safe-bottom border-t border-gray-100 dark:border-zinc-800 flex flex-col max-h-[80vh]">

        <!--把手-->
        <div class="w-full flex justify-center pt-3 pb-1" onclick="toggleSettings()">
            <div class="w-12 h-1.5 bg-gray-300 dark:bg-zinc-700 rounded-full"></div>
        </div>

        <div class="p-6 space-y-8 overflow-y-auto">

            <!-- 模式选择：双语 vs 纯净 -->
            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-sm font-bold text-gray-500 uppercase tracking-wider">阅读模式</span>
                </div>
                <div class="grid grid-cols-2 gap-3 p-1 bg-gray-100 dark:bg-zinc-800 rounded-xl">
                    <button onclick="setMode('bilingual')" id="btn-mode-bilingual" class="py-2.5 rounded-lg text-sm font-medium transition-all flex items-center justify-center gap-2">
                        <i class="ph ph-translate"></i> 中英对照
                    </button>
                    <button onclick="setMode('pure')" id="btn-mode-pure" class="py-2.5 rounded-lg text-sm font-medium transition-all flex items-center justify-center gap-2">
                        <i class="ph ph-book-open-text"></i> 只看译文
                    </button>
                </div>
            </div>

            <!-- 字体选择 & 加粗 -->
            <div class="space-y-3">
                <span class="text-sm font-bold text-gray-500 uppercase tracking-wider">字体风格</span>
                <div class="flex gap-3">
                    <button onclick="setFont('serif')" id="btn-font-serif" class="flex-1 border border-gray-200 dark:border-zinc-700 py-3 rounded-xl font-serif text-lg hover:bg-gray-50 dark:hover:bg-zinc-800 transition">
                        宋体
                    </button>
                    <button onclick="setFont('sans')" id="btn-font-sans" class="flex-1 border border-gray-200 dark:border-zinc-700 py-3 rounded-xl font-sans text-lg hover:bg-gray-50 dark:hover:bg-zinc-800 transition">
                        黑体
                    </button>
                    <!-- 加粗按钮 -->
                    <button onclick="toggleBold()" id="btn-font-bold" class="w-16 border border-gray-200 dark:border-zinc-700 rounded-xl flex items-center justify-center hover:bg-gray-50 dark:hover:bg-zinc-800 transition text-xl font-bold">
                        B
                    </button>
                </div>
            </div>

            <!-- 字号调节 (简化版) -->
            <div class="space-y-3">
                <div class="flex justify-between">
                    <span class="text-sm font-bold text-gray-500 uppercase tracking-wider">字号大小</span>
                    <span id="font-size-label" class="text-xs text-gray-400">100%</span>
                </div>
                <div class="flex gap-4">
                    <button onclick="changeFontSize(-10)" class="flex-1 py-3 bg-gray-100 dark:bg-zinc-800 rounded-xl hover:bg-gray-200 dark:hover:bg-zinc-700 transition flex items-center justify-center">
                        <span class="text-sm font-bold">A- 减小</span>
                    </button>
                    <button onclick="changeFontSize(10)" class="flex-1 py-3 bg-gray-100 dark:bg-zinc-800 rounded-xl hover:bg-gray-200 dark:hover:bg-zinc-700 transition flex items-center justify-center">
                        <span class="text-xl font-bold">A+ 增大</span>
                    </button>
                </div>
            </div>

            <!-- 主题颜色 -->
            <div class="space-y-3 pb-4">
                <span class="text-sm font-bold text-gray-500 uppercase tracking-wider">背景主题</span>
                <div class="flex gap-4">
                    <button onclick="setTheme('light')" class="flex-1 h-14 rounded-2xl border-2 border-gray-200 bg-white hover:border-blue-500 transition relative group">
                        <i class="ph ph-sun text-xl text-gray-400 group-hover:text-blue-500"></i>
                    </button>
                    <button onclick="setTheme('sepia')" class="flex-1 h-14 rounded-2xl border-2 border-amber-100 bg-[#f8f4e9] hover:border-amber-500 transition relative group">
                        <i class="ph ph-coffee text-xl text-amber-800/50 group-hover:text-amber-600"></i>
                    </button>
                    <button onclick="setTheme('dark')" class="flex-1 h-14 rounded-2xl border-2 border-zinc-700 bg-[#18181b] hover:border-blue-400 transition relative group">
                        <i class="ph ph-moon text-xl text-zinc-500 group-hover:text-blue-400"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Loader -->
    <script src="file_list.js"></script>
    <!-- Annotation Manager -->
    <script src="annotations.js"></script>

    <script>
        // --- State Management ---
        const state = {
            currentIndex: 0,
            fontSize: 100, // percentage
            theme: 'light',
            fontFamily: 'serif',
            isBold: false,
            mode: 'bilingual', // 'bilingual' or 'pure'
            settingsOpen: false
        };

        // --- DOM Elements ---
        const els = {
            content: document.getElementById('content'),
            drawer: document.getElementById('drawer'),
            drawerBackdrop: document.getElementById('drawer-backdrop'),
            settingsPanel: document.getElementById('settings-panel'),
            title: document.getElementById('header-title'),
            progressBar: document.getElementById('progress-bar'),
            pageIndicator: document.getElementById('page-indicator')
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            loadSettings();
            renderChapterList();
            loadChapter(state.currentIndex);
            updateSettingsUI();
        });

        function initApp() {
            if (typeof bookConfig !== 'undefined') document.title = bookConfig.title;

            // Navigation Events
            document.getElementById('menu-btn').onclick = toggleDrawer;
            document.getElementById('close-drawer').onclick = toggleDrawer;
            document.getElementById('drawer-backdrop').onclick = toggleDrawer;
            document.getElementById('settings-btn').onclick = toggleSettings;

            document.getElementById('prev-btn').onclick = () => navigate(-1);
            document.getElementById('next-btn').onclick = () => navigate(1);

            // Close settings on click outside
            document.addEventListener('click', (e) => {
                if (state.settingsOpen &&
                    !els.settingsPanel.contains(e.target) &&
                    !document.getElementById('settings-btn').contains(e.target)) {
                    toggleSettings();
                }
            });

            // Scroll Progress
            window.addEventListener('scroll', () => {
                const scrolled = window.scrollY;
                const max = document.body.scrollHeight - window.innerHeight;
                const pct = Math.min(100, Math.max(0, (scrolled / max) * 100));
                els.pageIndicator.innerText = Math.round(pct) + '%';
            });
        }

        // --- Core Content Logic ---
        async function loadChapter(index) {
            if (index < 0 || index >= bookConfig.files.length) return;

            state.currentIndex = index;
            saveSettings();
            updateNavUI();

            const file = bookConfig.files[index];
            els.title.innerText = file.title;

            // Loading placeholder
            els.content.style.opacity = '0.5';

            try {
                // Determine file path (handle both remote and local/static logic slightly)
                const response = await fetch(file.path);
                if (!response.ok) throw new Error('Fetch failed');

                const text = await response.text();

                // Parse Markdown with breaks enabled
                const rawHtml = marked.parse(text, { breaks: true });

                // Sanitize HTML to prevent XSS attacks
                const cleanHtml = DOMPurify.sanitize(rawHtml);

                // Inject sanitized HTML
                els.content.innerHTML = cleanHtml;

                // *** INTELLIGENT POST-PROCESSING ***
                processContentStructure();
                styleMetadata();

                // Reset Scroll
                window.scrollTo({ top: 0, behavior: 'auto' });
                els.content.style.opacity = '1';

                // 应用标注
                if (window.annotationManager) {
                    window.annotationManager.applyAnnotationsToChapter(file.path);
                }

            } catch (error) {
                els.content.innerHTML = `
                    <div class="p-8 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 rounded-2xl text-center my-10">
                        <i class="ph ph-warning-circle text-4xl mb-3"></i>
                        <p class="font-bold">无法加载章节</p>
                        <p class="text-sm mt-2 opacity-80">请确保已运行 start_reader.py 服务</p>
                    </div>
                `;
                els.content.style.opacity = '1';
            }
        }

        /**
         * 核心逻辑：分析 HTML 结构，标记原文和译文段落
         * 算法：
         * 1. 遍历所有 <p> 标签
         * 2. 如果包含 "【译文】" (strong标签内)，标记为 is-translation
         * 3. 在两个分割线 <hr> 之间，位于 is-translation 之前的段落，标记为 is-original
         */
        function processContentStructure() {
            const children = Array.from(els.content.children);
            let currentBlock = []; // Stores nodes between HRs

            // Helper to process a block of nodes
            const processBlock = (nodes) => {
                // Find translation indices
                const translationIndices = [];
                nodes.forEach((node, idx) => {
                    if (node.tagName === 'P' && node.innerHTML.includes('【译文】')) {
                        translationIndices.push(idx);
                        node.classList.add('is-translation');
                        // Wrap prefix for hiding in pure mode
                        // We target the standard markdown strong tag or plain text
                        node.innerHTML = node.innerHTML.replace(/(<strong>\s*【译文】\s*<\/strong>|【译文】)/g, '<span class="trans-prefix">$1</span>');
                    }
                });

                // Mark originals
                // Assumption: Content *before* a translation paragraph in this block is original
                // unless it's a header.
                if (translationIndices.length > 0) {
                    let lastTransIdx = -1;
                    translationIndices.forEach(transIdx => {
                        // Mark everything from lastTransIdx+1 to transIdx-1 as original
                        for (let i = lastTransIdx + 1; i < transIdx; i++) {
                            const n = nodes[i];
                            // Don't hide headers in pure mode, only paragraphs/lists
                            if (['P', 'UL', 'OL', 'BLOCKQUOTE'].includes(n.tagName)) {
                                n.classList.add('is-original');
                            }
                        }
                        lastTransIdx = transIdx;
                    });
                }
            };

            children.forEach(node => {
                if (node.tagName === 'HR') {
                    processBlock(currentBlock);
                    currentBlock = []; // Reset
                } else {
                    currentBlock.push(node);
                }
            });
            // Process remaining
            processBlock(currentBlock);
        }

        function styleMetadata() {
            // Style the first H1 and following metadata
            const h1 = els.content.querySelector('h1');
            if (h1) {
                let next = h1.nextElementSibling;
                let metaNodes = [];
                while(next && next.tagName !== 'HR') {
                    metaNodes.push(next);
                    next = next.nextElementSibling;
                }

                if (metaNodes.length > 0) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'metadata-block';
                    metaNodes.forEach(node => wrapper.appendChild(node));
                    h1.insertAdjacentElement('afterend', wrapper);
                    if(next && next.tagName === 'HR') next.remove(); // Remove first HR
                }
            }
        }

        // --- UI & Interactions ---

        function toggleDrawer() {
            const isOpen = !els.drawer.classList.contains('-translate-x-full');
            if (isOpen) {
                els.drawer.classList.add('-translate-x-full');
                els.drawerBackdrop.classList.add('opacity-0', 'pointer-events-none');
            } else {
                els.drawer.classList.remove('-translate-x-full');
                els.drawerBackdrop.classList.remove('opacity-0', 'pointer-events-none');
            }
        }

        function toggleSettings() {
            state.settingsOpen = !state.settingsOpen;
            if (state.settingsOpen) {
                els.settingsPanel.classList.remove('translate-y-full');
            } else {
                els.settingsPanel.classList.add('translate-y-full');
            }
        }

        function renderChapterList() {
            const list = document.getElementById('chapter-list');
            list.innerHTML = bookConfig.files.map((file, idx) => `
                <button onclick="loadChapter(${idx}); toggleDrawer();"
                    class="chapter-item w-full text-left p-4 rounded-xl text-sm transition-all duration-200 border border-transparent hover:bg-white hover:shadow-sm dark:hover:bg-zinc-800 ${idx === state.currentIndex ? 'bg-blue-50 text-blue-600 font-bold border-blue-100 dark:bg-blue-900/20 dark:text-blue-400 dark:border-blue-900/30' : 'text-gray-600 dark:text-gray-400'}">
                    <div class="truncate text-base">${file.title}</div>
                    <div class="text-xs opacity-50 mt-1 font-mono">${file.path.split('/').pop().replace('.md','')}</div>
                </button>
            `).join('');
        }

        function navigate(dir) {
            loadChapter(state.currentIndex + dir);
        }

        function updateNavUI() {
            document.getElementById('prev-btn').style.visibility = state.currentIndex > 0 ? 'visible' : 'hidden';
            document.getElementById('next-btn').style.display = state.currentIndex < bookConfig.files.length - 1 ? 'flex' : 'none';
            document.getElementById('nav-buttons').classList.remove('hidden');

            const progress = ((state.currentIndex + 1) / bookConfig.files.length) * 100;
            els.progressBar.style.width = `${progress}%`;

            renderChapterList(); // Re-render to update active state
        }

        // --- Settings Implementation ---

        function setMode(mode) {
            state.mode = mode;
            document.body.classList.remove('mode-bilingual', 'mode-pure');
            document.body.classList.add(`mode-${mode}`);
            saveSettings();
            updateSettingsUI();
        }

        function setFont(font) {
            state.fontFamily = font;
            document.body.classList.remove('font-serif', 'font-sans');
            document.body.classList.add(`font-${font}`);
            saveSettings();
            updateSettingsUI();
        }

        function setTheme(theme) {
            state.theme = theme;
            document.body.classList.remove('theme-light', 'theme-sepia', 'theme-dark');
            document.body.classList.add(`theme-${theme}`);
            saveSettings();
            updateSettingsUI(); // Although themes don't have active buttons in this UI, good practice
        }

        function changeFontSize(delta) {
            state.fontSize = Math.max(80, Math.min(160, state.fontSize + delta));
            document.documentElement.style.fontSize = `${state.fontSize}%`;
            document.getElementById('font-size-label').innerText = `${state.fontSize}%`;

            saveSettings();
        }

        function toggleBold() {
            state.isBold = !state.isBold;
            if (state.isBold) document.body.classList.add('font-weight-bold');
            else document.body.classList.remove('font-weight-bold');
            saveSettings();
            updateSettingsUI();
        }

        function updateSettingsUI() {
            // Update Mode Buttons
            const modeBtns = { 'bilingual': 'btn-mode-bilingual', 'pure': 'btn-mode-pure' };
            Object.keys(modeBtns).forEach(k => {
                const btn = document.getElementById(modeBtns[k]);
                if (k === state.mode) btn.classList.add('active-option');
                else btn.classList.remove('active-option');
            });

            // Update Font Buttons
            const fontBtns = { 'serif': 'btn-font-serif', 'sans': 'btn-font-sans' };
            Object.keys(fontBtns).forEach(k => {
                const btn = document.getElementById(fontBtns[k]);
                if (k === state.fontFamily) {
                    btn.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20', 'text-blue-600', 'dark:text-blue-400', 'border-transparent');
                } else {
                    btn.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20', 'text-blue-600', 'dark:text-blue-400', 'border-transparent');
                }
            });

            // Update Font Label
            document.getElementById('font-size-label').innerText = `${state.fontSize}%`;

            // Update Bold Button
            const boldBtn = document.getElementById('btn-font-bold');
            if (state.isBold) {
                boldBtn.classList.add('bg-black', 'text-white', 'dark:bg-white', 'dark:text-black', 'border-transparent');
            } else {
                boldBtn.classList.remove('bg-black', 'text-white', 'dark:bg-white', 'dark:text-black', 'border-transparent');
            }
        }

        function saveSettings() {
            try {
                localStorage.setItem('reader_state', JSON.stringify({
                    currentIndex: state.currentIndex,
                    fontSize: state.fontSize,
                    theme: state.theme,
                    fontFamily: state.fontFamily,
                    isBold: state.isBold,
                    mode: state.mode
                }));
            } catch (error) {
                console.warn('Failed to save settings:', error);
                // Fallback to memory storage
                window._tempSettings = { ...state };
            }
        }

        function loadSettings() {
            try {
                const saved = localStorage.getItem('reader_state');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    state.currentIndex = parsed.currentIndex || 0;
                    state.fontSize = parsed.fontSize || 100;
                    state.theme = parsed.theme || 'light';
                    state.fontFamily = parsed.fontFamily || 'serif';
                    state.mode = parsed.mode || 'bilingual';
                    state.isBold = parsed.isBold || false;

                    // Apply Loaded Settings
                    setTheme(state.theme);
                    setFont(state.fontFamily);
                    setMode(state.mode);
                    changeFontSize(0); // Trigger style update

                    // Apply Bold
                    if (state.isBold) document.body.classList.add('font-weight-bold');
                    updateSettingsUI();
                }
            } catch (error) {
                console.warn('Failed to load settings:', error);
                // Use default settings
                if (window._tempSettings) {
                    Object.assign(state, window._tempSettings);
                }
            }
        }
    </script>
</body>
</html>